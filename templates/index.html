<!html>
<html>
<head>
    <title>Palermo Hollywood, FTW</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='leaflet-0.6.4/leaflet.css') }}" />
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="{{ url_for('static', filename='leaflet-0.6.4/leaflet.ie.css') }}" />
    <![endif]-->
    <style type="text/css">
        html {
            margin: 0;
            padding: 0;
        }
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: relative;
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="{{ url_for('static', filename='jquery-1.10.2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='leaflet-0.6.4/leaflet.js') }}"></script>
    <script src="{{ url_for('static', filename='leaflet-bing-layer-0.0.1.js') }}"></script>
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript">
    var map = L.map('map').setView([-34.607214907435875, -58.440399169921875], 12);
    // Base tiles
    var stamenLayer = new L.TileLayer(
        'http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://creativecommons.org/licenses/by-sa/3.0">CC BY SA</a>.'
    });
    var bingKey = "ApmsCgK3jSH-D8Ttdbjj4yqUvHAqkNYxBG94Fc0GJis_09Cab9Co5ZyuxoqYgVIa";
    var bingRoadsLayer = L.bingLayer(bingKey, {
        type: "Road", // Change this to "Aerial" or "AerialWithLabels" to use the other layers.
        minZoom: 1,
        maxZoom: 18
    });
    var bingAerialLayer = L.bingLayer(bingKey, {
        type: "Aerial", // Change this to "Aerial" or "AerialWithLabels" to use the other layers.
        minZoom: 1,
        maxZoom: 18
    });
    var bingHybridLayer = L.bingLayer(bingKey, {
        type: "Road",
        minZoom: 1,
        maxZoom: 18
    });
    map.addLayer(bingAerialLayer);

    var radiusConstant = 0.5;
    var getRadius = function(value) {
        return Math.sqrt(value)*radiusConstant;
    };

    var list2color = {
        '501': '#50ade6', // light blue
        '502': '#6eb440', // green
        '503': '#ffda00'  // yellow
    }

    $.getJSON("/static/results.geojson", function (response) {
        var dataLayer = L.geoJson(response, {
            pointToLayer: function (feature, latlng) {
                var marker = new L.circleMarker(latlng, {
                    fillColor: list2color[feature.properties['leader']],
                    color: list2color[feature.properties['leader']],
                    fillOpacity: 0.4,
                    weight: 1
                })
                .setRadius(getRadius(feature.properties['margin_of_victory']))
                .bindPopup(
                    "<b>" + feature.properties['establecim'] + "</b><br>" +
                    feature.properties['direccion']
                );
                return marker;
            }
        }).addTo(map);
        dataLayer.addData(response);
    });
    </script>
</body>
</html>
